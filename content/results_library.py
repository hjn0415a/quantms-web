"""Spectral Library Results Page."""
import streamlit as st
from pathlib import Path
from src.common.common import page_setup
from src.common.results_helpers import get_workflow_dir

params = page_setup()

st.title("Spectral Library")

st.info("""
**Spectral Library Download**

Download the spectral library generated by EasyPQP for use in targeted proteomics
workflows (DIA/SWATH analysis with OpenSWATH or similar tools).
""")

if "workspace" not in st.session_state:
    st.warning("Please initialize your workspace first.")
    st.stop()

workflow_dir = get_workflow_dir(st.session_state["workspace"])

if not workflow_dir.exists():
    st.warning("No workspace found. Please run a workflow first.")
    st.stop()

library_dir = workflow_dir / "results" / "library"
library_tsv = library_dir / "spectral_library.tsv"

if library_tsv.exists():
    st.success("Spectral library available for download.")

    with open(library_tsv, "rb") as f:
        st.download_button(
            label="Download Spectral Library (TSV)",
            data=f,
            file_name="spectral_library.tsv",
            mime="text/tab-separated-values",
            use_container_width=True,
            type="primary",
        )

    # Preview option
    with st.expander("Preview Library Contents"):
        import pandas as pd
        try:
            df = pd.read_csv(library_tsv, sep="\t", nrows=100)
            st.dataframe(df, use_container_width=True)
            st.caption("Showing first 100 rows")
        except Exception as e:
            st.error(f"Could not preview: {e}")
else:
    st.info("Spectral library generation was not enabled or has not completed.")
    st.markdown("""
To generate a spectral library:
1. Go to **Configure** page
2. Enable **Generate Spectral Library** in the Library Generation tab
3. Run the workflow
""")
