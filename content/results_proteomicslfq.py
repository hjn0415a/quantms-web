from pathlib import Path
import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px

from src.common.common import page_setup
from src.common.results_helpers import get_abundance_data

# ================================
# Page setup
# ================================
params = page_setup()
st.title("ProteomicsLFQ Results")

# ================================
# Workspace check
# ================================
if "workspace" not in st.session_state:
    st.warning("Please initialize your workspace first.")
    st.stop()

# ================================
# Load abundance data
# ================================
res = get_abundance_data(st.session_state["workspace"])
if res is None:
    st.info(
        "Abundance data not available or incomplete. "
        "Please run the workflow and configure sample groups first."
    )
    st.stop()

pivot_df, expr_df, group_map = res

# ================================
# Tabs
# ================================
protein_tab, = st.tabs(["üß¨ Protein Table"])

# ================================
# Protein-level results
# ================================
with protein_tab:
    st.markdown("### üß¨ Protein-Level Abundance Table")
    st.info(
        "This protein-level table is generated by grouping all PSMs that map to the "
        "same protein and aggregating their intensities across samples.\n\n"
        "Additionally, log2 fold change and p-values are calculated between sample groups."
    )

    if pivot_df.empty:
        st.info("No protein-level data available.")
    else:
        st.session_state["pivot_df"] = pivot_df
        st.dataframe(pivot_df.sort_values("p-value"), use_container_width=True)

# ======================================================
# GO Enrichment Results 
# ======================================================
st.markdown("---")
st.subheader("üß¨ GO Enrichment Analysis")

results_dir = Path(st.session_state["workspace"]) / "topp-workflow" / "results" / "go-terms"
go_json_file = results_dir / "go_results.json"

if not go_json_file.exists():
    st.info("GO Enrichment results are not available yet. Please run the analysis first.")
else:
    import json
    import plotly.io as pio
    
    with open(go_json_file, "r") as f:
        go_data = json.load(f)
    
    bp_tab, cc_tab, mf_tab = st.tabs([
        "üß¨ Biological Process",
        "üè† Cellular Component",
        "‚öôÔ∏è Molecular Function",
    ])
    
    for tab, go_type in zip([bp_tab, cc_tab, mf_tab], ["BP", "CC", "MF"]):
        with tab:
            if go_type not in go_data:
                st.info(f"No enriched {go_type} terms found.")
                continue
            
            fig_json = go_data[go_type]["fig_json"]
            df_dict = go_data[go_type]["df_dict"]
            
            fig = pio.from_json(fig_json)
            
            df_go = pd.DataFrame(df_dict)
            
            if df_go.empty:
                st.info(f"No enriched {go_type} terms found.")
            else:
                st.plotly_chart(fig, use_container_width=True)
                
                st.markdown(f"#### {go_type} Enrichment Results")
                st.dataframe(df_go, use_container_width=True)