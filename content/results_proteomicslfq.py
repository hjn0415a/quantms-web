from pathlib import Path
import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px

from src.common.common import page_setup
from src.common.results_helpers import get_abundance_data

# ================================
# Page setup
# ================================
params = page_setup()
st.title("ProteomicsLFQ Results")

# ================================
# Workspace check
# ================================
if "workspace" not in st.session_state:
    st.warning("Please initialize your workspace first.")
    st.stop()

# ================================
# Load abundance data
# ================================
res = get_abundance_data(st.session_state["workspace"])
if res is None:
    st.info(
        "Abundance data not available or incomplete. "
        "Please run the workflow and configure sample groups first."
    )
    st.stop()

pivot_df, expr_df, group_map = res

# ================================
# Tabs
# ================================
protein_tab, = st.tabs(["ğŸ§¬ Protein Table"])

# ================================
# Protein-level results
# ================================
with protein_tab:
    st.markdown("### ğŸ§¬ Protein-Level Abundance Table")
    st.info(
        "This protein-level table is generated by grouping all PSMs that map to the "
        "same protein and aggregating their intensities across samples.\n\n"
        "Additionally, log2 fold change and p-values are calculated between sample groups."
    )

    if pivot_df.empty:
        st.info("No protein-level data available.")
    else:
        st.session_state["pivot_df"] = pivot_df
        st.dataframe(pivot_df.sort_values("p-value"), use_container_width=True)

# ======================================================
# GO Enrichment Results (from session_state)
# ======================================================
st.markdown("---")
st.subheader("ğŸ§¬ GO Enrichment Analysis")

# GO analysis must be executed in the execution step
if not st.session_state.get("go_ready", False):
    st.info("GO Enrichment results are not available yet. Please run the analysis first.")
else:
    go_results = st.session_state.get("go_results", {})

    if not go_results:
        st.warning("GO Enrichment results are empty.")
    else:
        bp_tab, cc_tab, mf_tab = st.tabs([
            "ğŸ§¬ Biological Process",
            "ğŸ  Cellular Component",
            "âš™ï¸ Molecular Function",
        ])
        
        # ê´„í˜¸ì™€ ë“¤ì—¬ì“°ê¸° ìˆ˜ì • ë¶€ë¶„
        for tab, go_type in zip([bp_tab, cc_tab, mf_tab], ["BP", "CC", "MF"]):
            with tab:
                if go_type not in go_results:
                    st.warning(f"No enriched {go_type} terms found.")
                    continue

                fig = go_results[go_type].get("fig")
                df_go = go_results[go_type].get("df")

                if fig is None or df_go is None or df_go.empty:
                    st.warning(f"No enriched {go_type} terms found.")
                else:
                    # ì°¨íŠ¸ ì¶œë ¥ (plotly_chart ì‚¬ìš©)
                    st.plotly_chart(fig, use_container_width=True)
                    # ë°ì´í„°í”„ë ˆì„ ì¶œë ¥
                    st.dataframe(df_go, use_container_width=True)